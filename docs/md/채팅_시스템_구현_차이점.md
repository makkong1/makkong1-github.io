# 채팅 시스템 구현 차이점 및 추가 사항

## 📋 개요
이 문서는 채팅 시스템 설계 문서(`채팅 시스템 설계.md`)와 실제 구현 간의 차이점 및 추가로 구현된 기능을 정리합니다.

---

## ✅ 설계 문서에 없지만 구현된 기능

### 1. 채팅방 나가기/삭제 기능 ⭐
**설계 문서**: "선택사항 (향후 구현)"으로만 언급 (1331-1333줄)

**실제 구현**:
- ✅ **채팅방 나가기**: `ConversationParticipant`의 `status = LEFT`, `isDeleted = true`, `deletedAt` 설정
- ✅ **채팅방 삭제**: `Conversation`의 `isDeleted = true`, `deletedAt` 설정
- ✅ **프론트엔드 UI**: 헤더에 메뉴 버튼(⋮) 추가, 드롭다운 메뉴로 나가기/삭제 옵션 제공
- ✅ **Soft Delete 패턴**: 프로젝트 전반의 패턴과 일치하도록 구현

**구현 위치**:
- 백엔드: `ConversationService.leaveConversation()`, `deleteConversation()`
- 프론트엔드: `ChatRoom.js` - `handleLeaveConversation()`, `handleDeleteConversation()`

---

### 2. 이미지 업로드 기능 ⭐
**설계 문서**: 플로우는 설명되어 있지만 (288-314줄), 실제 구현 여부는 명시되지 않음

**실제 구현**:
- ✅ **이미지 업로드 버튼**: 채팅 입력창에 이미지 업로드 버튼(📷) 추가
- ✅ **이미지 미리보기**: 업로드된 이미지를 채팅방에서 표시
- ✅ **이미지 확대**: 이미지 클릭 시 모달로 확대 표시
- ✅ **WebSocket 연동**: 이미지 메시지도 WebSocket을 통해 실시간 전송

**구현 위치**:
- 프론트엔드: `ChatRoom.js` - `handleImageUpload()`, `ImagePreviewModal`
- 백엔드: `ChatWebSocketController` - `IMAGE` 타입 메시지 처리

---

### 3. UI/UX 개선 사항

#### 3.1 말풍선 스타일
**설계 문서**: UI 스타일 관련 내용 없음

**실제 구현**:
- ✅ **말풍선 디자인**: 내 메시지와 상대방 메시지 구분
- ✅ **말풍선 꼬리**: `::after`를 사용한 말풍선 꼬리 효과
- ✅ **그림자 효과**: `box-shadow`로 입체감 추가
- ✅ **색상 구분**: 내 메시지는 primary 색상, 상대방 메시지는 회색 배경

#### 3.2 메시지 입력창 자동 포커스
**설계 문서**: 언급 없음

**실제 구현**:
- ✅ 채팅방 진입 시 메시지 입력창에 자동 포커스
- ✅ 메시지 전송 후 자동으로 다시 포커스

#### 3.3 메시지 순서 및 스크롤
**설계 문서**: 메시지 조회 플로우만 설명, UI 표시 순서는 명시되지 않음

**실제 구현**:
- ✅ 최신 메시지가 맨 아래에 표시되도록 정렬
- ✅ 새 메시지 수신 시 자동으로 맨 아래로 스크롤
- ✅ 백엔드에서 DESC로 받은 메시지를 reverse()하여 오래된 것부터 최신 순서로 표시

#### 3.4 상대방 이름 표시
**설계 문서**: 언급 없음

**실제 구현**:
- ✅ 상대방 메시지 위에 `senderUsername` 표시
- ✅ "알 수 없음" 대신 실제 username 표시

---

## 🔄 설계 문서와 일치하는 구현

### 1. WebSocket 실시간 채팅 ✅
- ✅ SockJS + STOMP 프로토콜 사용
- ✅ JWT 토큰 인증 (쿼리 파라미터로 전달)
- ✅ `/topic/conversation/{conversationIdx}` 구독
- ✅ `/app/chat.send`로 메시지 전송
- ✅ 실시간 메시지 수신 및 표시

### 2. 메시지 읽음 처리 ✅
- ✅ `markAsRead()` API 호출
- ✅ `ConversationParticipant.unreadCount` 관리
- ✅ `lastReadMessageIdx`, `lastReadAt` 업데이트

### 3. Soft Delete 패턴 ✅
- ✅ `isDeleted`, `deletedAt` 필드 사용
- ✅ 모든 엔티티에 일관되게 적용

### 4. 채팅방 타입 지원 ✅
- ✅ `DIRECT`, `CARE_REQUEST`, `MISSING_PET`, `MEETUP` 등 지원
- ✅ 범용 구조로 구현

---

## 📝 설계 문서에 있지만 아직 구현되지 않은 기능

### 1. 타이핑 표시 (Typing Indicator)
**설계 문서**: 353-367줄에 플로우 설명

**현재 상태**: ❌ 미구현
- `/app/chat.typing` 엔드포인트는 있지만 프론트엔드에서 사용하지 않음

### 2. 메시지 검색
**설계 문서**: 1335-1340줄에 Full-Text 인덱스 언급

**현재 상태**: ❌ 미구현
- 백엔드에 `searchMessages()` 메서드는 있지만 프론트엔드 UI 없음

### 3. 메시지 답장 기능 (Reply)
**설계 문서**: `reply_to_message_idx` 필드는 있지만 (686줄), UI 구현 없음

**현재 상태**: ❌ 미구현

### 4. 읽음 확인 (Read Receipt)
**설계 문서**: 1327-1329줄에 "실시간 읽음 확인 (WebSocket)" 언급

**현재 상태**: ⚠️ 부분 구현
- 기본 읽음 처리는 구현됨
- 실시간 읽음 상태 표시는 미구현

### 5. 대화방 아카이빙
**설계 문서**: 1342-1344줄에 언급

**현재 상태**: ❌ 미구현

---

## 🎨 추가된 UI/UX 기능

### 1. 채팅방 헤더
- ✅ 채팅방 타입별 제목 표시 (실종제보 채팅, 케어 요청 채팅 등)
- ✅ 상대방 이름 및 연결 상태 표시 (🟢 연결됨 / 🔴 연결 중...)
- ✅ 메뉴 버튼 (나가기/삭제)

### 2. 메시지 표시
- ✅ 메시지 타입별 표시 (TEXT, IMAGE)
- ✅ 시간 표시 (1분 이상 간격일 때만)
- ✅ 내 메시지/상대방 메시지 구분

### 3. 이미지 처리
- ✅ 이미지 업로드 버튼
- ✅ 이미지 미리보기
- ✅ 이미지 확대 모달
- ✅ 업로드 중 로딩 표시

---

## 🔧 기술적 차이점

### 1. WebSocket 연결 URL
**설계 문서**: `ws://localhost:8080/chat` (190줄)

**실제 구현**: `http://localhost:8080/ws?token={token}`
- SockJS를 사용하므로 HTTP 기반
- 토큰을 쿼리 파라미터로 전달

### 2. 메시지 정렬
**설계 문서**: 명시되지 않음

**실제 구현**:
- 백엔드: `DESC` 정렬 (최신부터)
- 프론트엔드: `reverse()`하여 오래된 것부터 최신 순서로 표시

### 3. 파일 업로드
**설계 문서**: `/api/files/upload` (295줄)

**실제 구현**: `uploadApi.uploadImage()` 사용
- 실제 엔드포인트는 프로젝트의 파일 업로드 API 사용

---

## 📊 요약

### 구현 완료 ✅
1. ✅ 채팅방 나가기/삭제 (설계 문서에는 선택사항)
2. ✅ 이미지 업로드 및 표시
3. ✅ 말풍선 스타일 UI
4. ✅ 메시지 자동 포커스
5. ✅ 메시지 순서 및 스크롤 최적화
6. ✅ WebSocket 실시간 채팅
7. ✅ 읽음 처리

### 미구현 ❌
1. ❌ 타이핑 표시
2. ❌ 메시지 검색 UI
3. ❌ 메시지 답장 기능
4. ❌ 실시간 읽음 확인 표시
5. ❌ 대화방 아카이빙

### 개선 사항 🎨
- UI/UX가 설계 문서보다 더 풍부하게 구현됨
- 사용자 경험을 고려한 추가 기능 다수 구현

---

## 📅 마지막 업데이트
- 날짜: 2025년
- 작성자: AI Assistant
- 버전: 1.0

