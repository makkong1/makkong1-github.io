# 반려동물 기능 문서

## 개요
사용자가 자신의 반려동물 정보를 등록하고 관리할 수 있는 기능입니다. 펫케어 요청, 실종 제보 등에서 재사용됩니다.

## 데이터베이스 구조

### 테이블

#### 1. pets (반려동물 프로필)
- 사용자가 등록한 반려동물의 기본 정보를 저장
- 주요 필드:
  - `pet_name`: 애완동물 이름
  - `pet_type`: 종류 (DOG, CAT, BIRD, RABBIT, HAMSTER, ETC)
  - `breed`: 품종
  - `gender`: 성별 (M, F, UNKNOWN)
  - `age`: 나이 (문자열, 예: "3살", "5개월")
  - `birth_date`: 생년월일
  - `weight`: 몸무게 (DECIMAL(5,2))
  - `is_neutered`: 중성화 여부
  - `health_info`: 건강 정보
  - `special_notes`: 특이사항
  - `profile_image_url`: 프로필 이미지 URL (하위 호환성용, 실제로는 File 테이블 사용)

**참고**: 펫 이미지는 `file` 테이블에서 관리됩니다 (`target_type='PET'`, `target_idx=펫idx`)

#### 2. pet_vaccinations (반려동물 예방접종 기록)
- 예방접종 이력 관리
- 주요 필드:
  - `pet_idx`: 펫 ID (FK)
  - `vaccine_name`: 백신 이름
  - `vaccinated_at`: 접종일
  - `next_due`: 다음 접종 예정일
  - `notes`: 메모

## 백엔드 구조

### 엔티티 (Entity)
- `Pet.java`: 반려동물 엔티티
- `PetVaccination.java`: 예방접종 기록 엔티티
- `PetType.java`: 펫 종류 Enum (DOG, CAT, BIRD, RABBIT, HAMSTER, ETC)
- `PetGender.java`: 펫 성별 Enum (M, F, UNKNOWN)

**참고**: 펫 이미지는 `AttachmentFile` 엔티티로 관리됩니다 (`FileTargetType.PET`)

### DTO
- `PetDTO.java`: 펫 데이터 전송 객체
  - `profileImageUrl`: 펫 이미지 URL (File 테이블에서 자동 조회)
- `PetVaccinationDTO.java`: 예방접종 데이터 전송 객체

### Repository
- `PetRepository.java`: 펫 데이터 접근
  - `findByUserIdAndNotDeleted()`: 사용자별 펫 목록 조회
  - `findByUserIdxAndNotDeleted()`: 사용자 idx로 펫 목록 조회
  - `findByPetTypeAndIsDeletedFalse()`: 타입별 펫 조회
- `PetVaccinationRepository.java`: 예방접종 데이터 접근

**참고**: 펫 이미지는 `AttachmentFileRepository`를 통해 조회합니다 (`FileTargetType.PET`)

### Service
- `PetService.java`: 펫 비즈니스 로직
  - `createPet()`: 펫 생성 (이미지 File 테이블에 자동 동기화)
  - `getPet()`: 펫 조회 (File 테이블에서 이미지 자동 조회)
  - `updatePet()`: 펫 수정 (이미지 File 테이블에 자동 동기화)
  - `deletePet()`: 펫 삭제 (소프트 삭제)
  - `restorePet()`: 펫 복구
  - `getPetsByUserId()`: 사용자별 펫 목록
  - `getPetsByUserIdx()`: 사용자 idx로 펫 목록 조회
  - `getPetsByType()`: 타입별 펫 조회
  - ETC 타입 선택 시 breed 필수 검증

### Controller
- `PetController.java`: 펫 REST API 엔드포인트
  - `GET /api/pets`: 자신의 펫 목록 조회
  - `GET /api/pets/{petIdx}`: 펫 상세 조회
  - `POST /api/pets`: 펫 생성
  - `PUT /api/pets/{petIdx}`: 펫 수정
  - `DELETE /api/pets/{petIdx}`: 펫 삭제
  - `POST /api/pets/{petIdx}/restore`: 펫 복구
  - `GET /api/pets/type/{petType}`: 타입별 펫 조회

### Converter
- `PetConverter.java`: Pet Entity ↔ PetDTO 변환
  - File 테이블에서 펫 이미지 자동 조회하여 `profileImageUrl` 설정
  - File 테이블에 이미지가 있으면 우선 사용, 없으면 엔티티의 `profileImageUrl` 사용 (하위 호환성)
- `PetVaccinationConverter.java`: PetVaccination Entity ↔ PetVaccinationDTO 변환

## API 엔드포인트

### 펫 목록 조회
```
GET /api/pets
Authorization: Bearer {token}
```

**응답:**
```json
[
  {
    "idx": 1,
    "petName": "뽀삐",
    "petType": "DOG",
    "breed": "골든 리트리버",
    "gender": "M",
    "age": "3살",
    "weight": 25.5,
    "isNeutered": true
  }
]
```

### 펫 생성
```
POST /api/pets
Authorization: Bearer {token}
Content-Type: application/json

{
  "petName": "뽀삐",
  "petType": "DOG",
  "breed": "골든 리트리버",
  "gender": "M",
  "age": "3살",
  "weight": 25.5,
  "isNeutered": true,
  "birthDate": "2021-01-15"
}
```

### 펫 수정
```
PUT /api/pets/{petIdx}
Authorization: Bearer {token}
Content-Type: application/json

{
  "petName": "뽀삐",
  "weight": 26.0
}
```

### 펫 삭제
```
DELETE /api/pets/{petIdx}
Authorization: Bearer {token}
```

### 펫 이미지 업로드
```
POST /api/uploads/images
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [이미지 파일]
category: pet
ownerType: user
ownerId: [사용자 ID]
entityId: [펫 ID] (수정 시)
```

**응답:**
```json
{
  "path": "pet/user123/20241129_abc123.jpg",
  "filename": "20241129_abc123.jpg",
  "url": "http://localhost:8080/api/uploads/file?path=pet/user123/20241129_abc123.jpg",
  "contentType": "image/jpeg",
  "size": 123456
}
```

### 펫케어 요청 생성 (펫 정보 포함)
```
POST /api/care-requests
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "주말 여행 동안 강아지 산책 도와주세요",
  "description": "요청 내용...",
  "userId": 1,
  "petIdx": 5  // 선택사항: 관련 펫 ID
}
```

**응답:**
```json
{
  "idx": 1,
  "title": "주말 여행 동안 강아지 산책 도와주세요",
  "description": "요청 내용...",
  "petIdx": 5,
  "pet": {
    "idx": 5,
    "petName": "뽀삐",
    "petType": "DOG",
    "breed": "골든 리트리버",
    "profileImageUrl": "http://localhost:8080/api/uploads/file?path=pet/user123/image.jpg"
  }
}
```

## 펫 이미지 관리

### File 테이블 통합
- 펫 이미지는 범용 `file` 테이블에서 관리됩니다
- `target_type='PET'`, `target_idx=펫idx`로 저장
- 다른 엔티티(BOARD, COMMENT 등)와 동일한 방식으로 관리
- 펫 생성/수정 시 이미지 URL이 자동으로 File 테이블에 동기화됨
- 펫 조회 시 File 테이블에서 이미지를 자동으로 조회하여 `profileImageUrl`에 설정

### 이미지 업로드
- 프론트엔드에서 파일 선택 → 업로드 → URL 자동 입력
- `POST /api/uploads/images` 엔드포인트 사용
- `category='pet'`로 설정하여 펫 이미지로 분류

## 펫 정보 연동 기능

### 펫케어 요청 연동
- **CareRequest 엔티티**: `pet` 필드 추가 (ManyToOne, 선택사항)
- **작성 시**: 펫 목록에서 선택 가능, 선택한 펫 정보가 오른쪽 카드에 표시
- **상세 페이지**: 관련 펫 정보 섹션에 펫 상세 정보 표시
  - 펫 이미지 (없으면 "사진 없음")
  - 이름, 종류, 품종, 나이, 성별, 색상, 몸무게, 건강 정보, 특이사항

### 실종 제보 연동
- **작성 시**: 펫 목록에서 선택 가능
- 선택한 펫 정보가 폼 필드에 자동 입력:
  - 이름, 종류, 품종, 성별, 나이, 색상, 이미지
- 펫 정보를 오른쪽 카드에 표시

### UI/UX
- **레이아웃**: 왼쪽 폼 + 오른쪽 펫 정보 카드 (2열)
- **반응형**: 모바일/태블릿에서는 세로 배치 (1열)
- **이미지 처리**: 이미지 없을 때 "사진 없음" 플레이스홀더 표시
- **로딩 상태**: 펫 목록 불러오는 중 표시

## 주요 특징

1. **소프트 삭제**: 펫 삭제 시 실제로 삭제되지 않고 `is_deleted` 플래그만 설정
2. **연관 데이터**: 펫 이미지는 File 테이블에서 관리, 예방접종 기록은 펫과 함께 관리
3. **재사용성**: 펫케어 요청, 실종 제보 등에서 등록된 펫 정보 재사용 가능
4. **인증 필수**: 모든 API는 인증된 사용자만 접근 가능
5. **자신의 펫만 관리**: 사용자는 자신의 펫만 조회/수정/삭제 가능
6. **파일 관리 통합**: 펫 이미지를 범용 File 테이블로 관리하여 일관성 유지
7. **ETC 타입 검증**: 기타 종류 선택 시 breed 필수 입력 검증

## 프론트엔드 구조

### 컴포넌트
- `UserProfileModal.js`: 사용자 프로필 모달
  - 펫 목록 표시
  - 펫 추가/수정/삭제 기능
  - 펫 이미지 업로드 기능
- `CareRequestForm.js`: 펫케어 요청 작성 폼
  - 펫 목록 불러오기
  - 펫 선택 기능
  - 선택한 펫 정보 오른쪽 카드 표시
- `CareRequestDetailPage.js`: 펫케어 요청 상세 페이지
  - 관련 펫 정보 섹션 표시
  - 펫 이미지 및 상세 정보 표시
- `MissingPetBoardForm.js`: 실종 제보 작성 폼
  - 펫 목록 불러오기
  - 펫 선택 시 폼 필드 자동 입력
  - 선택한 펫 정보 오른쪽 카드 표시

### API 클라이언트
- `userApi.js`: 펫 관련 API
  - `petApiClient.getMyPets()`: 자신의 펫 목록 조회
  - `petApiClient.getPet(petIdx)`: 펫 상세 조회
  - `petApiClient.createPet(petData)`: 펫 생성
  - `petApiClient.updatePet(petIdx, petData)`: 펫 수정
  - `petApiClient.deletePet(petIdx)`: 펫 삭제
  - `petApiClient.restorePet(petIdx)`: 펫 복구

## 데이터 흐름

### 펫 이미지 저장 흐름
1. 사용자가 펫 이미지 파일 선택
2. `POST /api/uploads/images` (category='pet') 호출
3. File 테이블에 저장 (`target_type='PET'`, `target_idx=펫idx`)
4. 반환된 URL을 `profileImageUrl`에 저장
5. 펫 생성/수정 시 `PetService`가 File 테이블에 동기화

### 펫 정보 조회 흐름
1. `GET /api/pets` 또는 `GET /api/pets/{petIdx}` 호출
2. `PetConverter.toDTO()`에서 File 테이블 조회
3. File 테이블에 이미지가 있으면 `profileImageUrl`에 설정
4. 없으면 엔티티의 `profileImageUrl` 사용 (하위 호환성)

### 펫케어 요청 연동 흐름
1. 사용자가 펫케어 요청 작성 시 펫 선택
2. `POST /api/care-requests` 호출 시 `petIdx` 포함
3. `CareRequestService`에서 펫 소유자 검증 후 저장
4. 상세 페이지 조회 시 `CareRequestDTO`에 펫 정보 포함
5. 프론트엔드에서 펫 정보 섹션에 표시

## 기술 스택 및 아키텍처

### 백엔드
- **Spring Boot 3.5.7**: REST API 서버
- **JPA/Hibernate**: ORM 및 데이터베이스 접근
- **MySQL**: 관계형 데이터베이스
- **JWT**: 인증 및 권한 관리
- **File Storage Service**: 파일 업로드 및 관리

### 프론트엔드
- **React 19.2.0**: UI 라이브러리
- **Styled Components**: CSS-in-JS 스타일링
- **Axios**: HTTP 클라이언트
- **Context API**: 전역 상태 관리 (AuthContext, ThemeContext)

### 데이터베이스 설계 원칙
- **소프트 삭제**: 모든 주요 엔티티에 `is_deleted` 플래그 사용
- **타임스탬프 자동 관리**: `@PrePersist`, `@PreUpdate`로 `created_at`, `updated_at` 자동 설정
- **파일 관리 통합**: 범용 `file` 테이블로 모든 파일 관리
- **Enum 타입**: 타입 안정성을 위한 Enum 사용 (PetType, PetGender, FileTargetType)

## 보안 및 검증

### 인증
- 모든 펫 관련 API는 JWT 토큰 인증 필수
- 사용자는 자신의 펫만 조회/수정/삭제 가능

### 검증 규칙
- ETC 타입 선택 시 `breed` 필수 입력
- 펫케어 요청에 펫 연결 시 펫 소유자 검증
- 이미지 파일 크기 제한 (최대 5MB)
- 허용된 이미지 형식만 업로드 가능 (JPG, PNG, GIF, WEBP)

## 향후 확장 계획

1. 예방접종 알림 기능
2. 펫 건강 기록 관리
3. 펫 이미지 다중 업로드 (현재는 단일 이미지만)
4. 펫 정보 통계 및 분석 기능
5. 펫 정보 공유 기능 (다른 사용자에게 펫 정보 공개 여부 설정)

