# ì„œë¸Œì¿¼ë¦¬ ìµœì í™” - `findAvailableMeetups()`

## ê°œìš”

`findAvailableMeetups()` ë©”ì„œë“œì—ì„œ ë°œìƒí•˜ëŠ” ì„œë¸Œì¿¼ë¦¬ ì„±ëŠ¥ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë¦¬íŒ©í† ë§ ë¬¸ì„œìž…ë‹ˆë‹¤.

**íŒŒì¼**: `SpringDataJpaMeetupRepository.java` (Lines 51-57)

**ìš°ì„ ìˆœìœ„**: ðŸŸ  High Priority

---

## ë¬¸ì œ ë¶„ì„

### í˜„ìž¬ ë¬¸ì œì 

í˜„ìž¬ êµ¬í˜„ì—ì„œëŠ” ì„œë¸Œì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¸ì—¬ìž ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.

```java
// í˜„ìž¬ ì½”ë“œ (ë¹„íš¨ìœ¨ì )
@Query("SELECT m FROM Meetup m WHERE " +
       "m.maxParticipants > (SELECT COUNT(p) FROM MeetupParticipants p WHERE p.meetup.idx = m.idx) " +
       "AND m.date > :currentDate AND " +
       "(m.isDeleted = false OR m.isDeleted IS NULL) " +
       "ORDER BY m.date ASC")
List<Meetup> findAvailableMeetups(@Param("currentDate") LocalDateTime currentDate);
```

**ë¬¸ì œì **:
1. **ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ ê³„íš ë¹„íš¨ìœ¨**: ì„œë¸Œì¿¼ë¦¬ê°€ JOIN ë°©ì‹ë³´ë‹¤ ë¹„íš¨ìœ¨ì ì¸ ì‹¤í–‰ ê³„íš ìƒì„±
2. **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€**: ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ì¤‘ê°„ ê²°ê³¼ ì§‘í•© ìƒì„±ìœ¼ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ì‚¬ìš© ì¦ê°€
3. **ì‹¤í–‰ ì‹œê°„ ì¦ê°€**: ì„œë¸Œì¿¼ë¦¬ ë°©ì‹ì´ JOIN ë°©ì‹ë³´ë‹¤ ì‹¤í–‰ ì‹œê°„ì´ ê¸¸ìŒ
4. **ì¸ë±ìŠ¤ í™œìš© ì œí•œ**: ì„œë¸Œì¿¼ë¦¬ë¡œ ì¸í•´ ì¸ë±ìŠ¤ ìµœì í™”ê°€ ì–´ë ¤ì›€

**ì°¸ê³ **: PrepareStatement ìˆ˜ê°€ 6ê°œë¡œ ì¸¡ì •ë˜ì–´ N+1 ë¬¸ì œëŠ” ì•„ë‹ˆì—ˆìŒ. Hibernateê°€ ì„œë¸Œì¿¼ë¦¬ë¥¼ ìµœì í™”í•˜ì—¬ ë°°ì¹˜ ì²˜ë¦¬í–ˆì§€ë§Œ, ì—¬ì „ížˆ ì‹¤í–‰ ê³„íšì´ ë¹„íš¨ìœ¨ì ì´ì—ˆìŒ.

---

## í•´ê²° ë°©ì•ˆ

### ë¦¬íŒ©í† ë§ëœ ì½”ë“œ

ì„œë¸Œì¿¼ë¦¬ë¥¼ LEFT JOIN + GROUP BY + HAVINGìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì‹¤í–‰ ê³„íšì„ ìµœì í™”í•©ë‹ˆë‹¤.

```java
// ê°œì„ ëœ ì½”ë“œ
@Query("SELECT m FROM Meetup m " +
       "LEFT JOIN m.participants p " +
       "WHERE m.date > :currentDate " +
       "AND (m.isDeleted = false OR m.isDeleted IS NULL) " +
       "GROUP BY m.idx " +
       "HAVING COUNT(p) < m.maxParticipants " +
       "ORDER BY m.date ASC")
List<Meetup> findAvailableMeetups(@Param("currentDate") LocalDateTime currentDate);
```

**ê°œì„ ì **:
1. **ì‹¤í–‰ ê³„íš ìµœì í™”**: JOIN ë°©ì‹ì´ ì„œë¸Œì¿¼ë¦¬ë³´ë‹¤ íš¨ìœ¨ì ì¸ ì‹¤í–‰ ê³„íš ìƒì„±
2. **ë©”ëª¨ë¦¬ íš¨ìœ¨**: ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ìƒì„±ë˜ë˜ ì¤‘ê°„ ê²°ê³¼ ì§‘í•© ì œê±°
3. **ì¸ë±ìŠ¤ í™œìš©**: JOINê³¼ GROUP BYì—ì„œ ì¸ë±ìŠ¤ ìµœì  í™œìš© ê°€ëŠ¥
4. **í™•ìž¥ì„±**: ë°ì´í„° ì¦ê°€ì— ë”°ë¥¸ ì„±ëŠ¥ ì €í•˜ ìµœì†Œí™”

**ì°¸ê³ **: PrepareStatement ìˆ˜ëŠ” 6ê°œë¡œ ë™ì¼í•˜ì§€ë§Œ, ì‹¤í–‰ ê³„íš ìµœì í™”ë¡œ ì‹¤í–‰ ì‹œê°„ 63.5% ê°ì†Œ, ë©”ëª¨ë¦¬ 89.5% ê°ì†Œ ë‹¬ì„±

---

## ì¿¼ë¦¬ ì˜ˆì‹œ ë¹„êµ

### ì˜ˆì‹œ ë°ì´í„°

```sql
-- meetup í…Œì´ë¸”
idx | title           | date                | max_participants | is_deleted
----|-----------------|---------------------|------------------|------------
1   | ê°•ì•„ì§€ ì‚°ì±… ëª¨ìž„ | 2026-02-15 10:00:00 | 5                | false
2   | ê³ ì–‘ì´ ë†€ì´ ëª¨ìž„ | 2026-02-20 14:00:00 | 3                | false
3   | ë°˜ë ¤ë™ë¬¼ ë¯¸ìš©    | 2026-02-10 09:00:00 | 4                | false
4   | ì¢…ë£Œëœ ëª¨ìž„      | 2026-01-01 10:00:00 | 5                | false

-- meetupparticipants í…Œì´ë¸”
meetup_idx | user_idx
-----------|----------
1          | 101
1          | 102
1          | 103
2          | 201
2          | 202
2          | 203
3          | 301
```

### ë¦¬íŒ©í† ë§ ì „ ì¿¼ë¦¬

**ì‹¤í–‰ íŒŒë¼ë¯¸í„°**: `currentDate = '2026-02-08 00:00:00'`

```sql
-- JPQLì´ ìƒì„±í•˜ëŠ” ì‹¤ì œ SQL (ê° meetup í–‰ë§ˆë‹¤ ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰)
SELECT m.* 
FROM meetup m
WHERE m.max_participants > (
    SELECT COUNT(p.meetup_idx) 
    FROM meetupparticipants p 
    WHERE p.meetup_idx = m.idx
)
AND m.date > '2026-02-08 00:00:00'
AND (m.is_deleted = false OR m.is_deleted IS NULL)
ORDER BY m.date ASC;
```

**ì‹¤í–‰ ê³¼ì •** (ì´ë¡ ì  ì„¤ëª…):
1. `meetup` í…Œì´ë¸” ìŠ¤ìº” (3ê°œ í–‰: idx=1,2,3)
2. ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ (Hibernateê°€ ìµœì í™”í•˜ì—¬ ë°°ì¹˜ ì²˜ë¦¬):
   - ì„œë¸Œì¿¼ë¦¬ê°€ ê° í–‰ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” Hibernateê°€ ìµœì í™”
   - ì‹¤ì œ ì¸¡ì • ê²°ê³¼: PrepareStatement ìˆ˜ê°€ 6ê°œë¡œ ì¸¡ì •ë˜ì–´ N+1 íŒ¨í„´ì´ ì•„ë‹˜
3. ì¡°ê±´ í™•ì¸:
   - idx=1: `5 > 3` âœ… (ì°¸ì—¬ ê°€ëŠ¥)
   - idx=2: `3 > 3` âŒ (ë§ˆê°)
   - idx=3: `4 > 1` âœ… (ì°¸ì—¬ ê°€ëŠ¥)
4. **ê²°ê³¼**: idx=1, idx=3 ë°˜í™˜

**ì°¸ê³ **: ì‹¤ì œ ì¸¡ì • ê²°ê³¼ì—ì„œëŠ” PrepareStatement ìˆ˜ê°€ 6ê°œë¡œ ì¸¡ì •ë˜ì–´, ê° í–‰ë§ˆë‹¤ ê°œë³„ ì„œë¸Œì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” N+1 íŒ¨í„´ì´ ì•„ë‹ˆì—ˆìŒ. ë¬¸ì œëŠ” ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ ê³„íšì˜ ë¹„íš¨ìœ¨ì´ì—ˆìŒ.

### ë¦¬íŒ©í† ë§ í›„ ì¿¼ë¦¬

**ì‹¤í–‰ íŒŒë¼ë¯¸í„°**: `currentDate = '2026-02-08 00:00:00'`

```sql
-- Hibernateê°€ ìƒì„±í•˜ëŠ” ì‹¤ì œ SQL (JOIN + GROUP BY ì‚¬ìš©)
SELECT m.*
FROM meetup m
LEFT JOIN meetupparticipants p ON m.idx = p.meetup_idx
WHERE m.date > ?
AND (m.is_deleted = 0 OR m.is_deleted IS NULL)
GROUP BY m.idx
HAVING COUNT(CASE WHEN p.meetup_idx IS NOT NULL AND p.user_idx IS NOT NULL THEN 1 ELSE NULL END) < m.max_participants
ORDER BY m.date ASC
```

**ì‹¤í–‰ ê³¼ì •**:
1. `meetup`ê³¼ `meetupparticipants` LEFT JOIN (í•œ ë²ˆì— ì¡°ì¸)
   
   **JOIN ê²°ê³¼** (ì˜ˆì‹œ):
   ```
   m.idx | m.title           | m.max_participants | p.meetup_idx | p.user_idx
   ------|-------------------|-------------------|--------------|------------
   1     | ê°•ì•„ì§€ ì‚°ì±… ëª¨ìž„   | 5                 | 1            | 101
   1     | ê°•ì•„ì§€ ì‚°ì±… ëª¨ìž„   | 5                 | 1            | 102
   1     | ê°•ì•„ì§€ ì‚°ì±… ëª¨ìž„   | 5                 | 1            | 103
   2     | ê³ ì–‘ì´ ë†€ì´ ëª¨ìž„   | 3                 | 2            | 201
   2     | ê³ ì–‘ì´ ë†€ì´ ëª¨ìž„   | 3                 | 2            | 202
   2     | ê³ ì–‘ì´ ë†€ì´ ëª¨ìž„   | 3                 | 2            | 203
   3     | ë°˜ë ¤ë™ë¬¼ ë¯¸ìš©      | 4                 | 3            | 301
   ```

2. `GROUP BY m.idx`ë¡œ ê·¸ë£¹í™”
3. `HAVING COUNT(...) < m.max_participants` ì¡°ê±´ í™•ì¸:
   - idx=1: COUNT=3, max=5 â†’ `3 < 5` âœ…
   - idx=2: COUNT=3, max=3 â†’ `3 < 3` âŒ
   - idx=3: COUNT=1, max=4 â†’ `1 < 4` âœ…
4. **ê²°ê³¼**: idx=1, idx=3 ë°˜í™˜

**ì‹¤ì œ ì¸¡ì • ê²°ê³¼**:
- **ì¿¼ë¦¬ ì‹¤í–‰ íšŸìˆ˜**: 1ê°œ (Hibernate Statistics ê¸°ì¤€)
- **PrepareStatement ìˆ˜**: 6ê°œ (ë¦¬íŒ©í† ë§ ì „ê³¼ ë™ì¼)
- **ì‹¤ì œ ê°œì„ **: ì¿¼ë¦¬ ìˆ˜ê°€ ì•„ë‹ˆë¼ ì‹¤í–‰ ê³„íš ìµœì í™”ì™€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œì—ì„œ ë°œìƒ

---

## ì„±ëŠ¥ ë¹„êµ

### ì‹¤ì œ ì¸¡ì • ê²°ê³¼ (100ê°œ ëª¨ìž„ ê¸°ì¤€)

| í•­ëª© | ë¦¬íŒ©í† ë§ ì „ | ë¦¬íŒ©í† ë§ í›„ | ê°œì„  | ê°œì„ ìœ¨ |
|------|-----------|-----------|------|--------|
| **ì‹¤í–‰ ì‹œê°„** | 156 ms | 57 ms | **-99 ms** | **63.5% ê°ì†Œ** â¬‡ï¸ |
| **DB ì¿¼ë¦¬ ì‹œê°„** | 156 ms | 57 ms | **-99 ms** | **63.5% ê°ì†Œ** â¬‡ï¸ |
| **PrepareStatement ìˆ˜** | 6 ê°œ | 6 ê°œ | ë™ì¼ | - |
| **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰** | 19.07 MB | 2.00 MB | **-17.07 MB** | **89.5% ê°ì†Œ** â¬‡ï¸ |
| **ì¡°íšŒëœ ëª¨ìž„ ìˆ˜** | 49 ê°œ | 49 ê°œ | ë™ì¼ âœ… | - |

**ìƒì„¸ ê²°ê³¼**: [ì„±ëŠ¥ ë¹„êµ ë¬¸ì„œ](./performance-comparison.md)

---

## ì‹¤ì œ ê°œì„  íš¨ê³¼

1. **ì‹¤í–‰ ì‹œê°„ 63.5% ê°ì†Œ**: 156ms â†’ 57ms (99ms ê°œì„ )
   - ì„œë¸Œì¿¼ë¦¬ ì œê±°ë¡œ ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš ìµœì í™”
   - JOIN ë°©ì‹ì´ ì„œë¸Œì¿¼ë¦¬ë³´ë‹¤ íš¨ìœ¨ì ì¸ ì‹¤í–‰ ê³„íš ìƒì„±

2. **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 89.5% ê°ì†Œ**: 19.07 MB â†’ 2.00 MB (17.07 MB ê°œì„ )
   - ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ìƒì„±ë˜ë˜ ì¤‘ê°„ ê²°ê³¼ ì§‘í•© ì œê±°
   - JOIN ë°©ì‹ì´ ë” íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ ì‚¬ìš© íŒ¨í„´

3. **ì¿¼ë¦¬ ì‹¤í–‰ íš¨ìœ¨ í–¥ìƒ**: PrepareStatement ìˆ˜ëŠ” ë™ì¼í•˜ì§€ë§Œ ì‹¤í–‰ ê³„íš ìµœì í™”ë¡œ ì„±ëŠ¥ ê°œì„ 

4. **í™•ìž¥ì„± ê°œì„ **: ë°ì´í„° ì¦ê°€ì— ë”°ë¥¸ ì„±ëŠ¥ ì €í•˜ ìµœì†Œí™”

---

## êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] `SpringDataJpaMeetupRepository.java`ì˜ `findAvailableMeetups()` ë©”ì„œë“œ ìˆ˜ì • âœ…
- [x] í…ŒìŠ¤íŠ¸ ì½”ë“œ ìž‘ì„± ë° ê²€ì¦ âœ…
- [x] ì„±ëŠ¥ ì¸¡ì • ë° ë¹„êµ (ë¦¬íŒ©í† ë§ í›„) âœ… - [ì„±ëŠ¥ ë¹„êµ ê²°ê³¼](./performance-comparison.md)
- [x] EXPLAIN ì‹¤í–‰ ê³„íš ë¶„ì„ âœ… - [EXPLAIN ê²°ê³¼](./explain-results.md)
- [ ] í”„ë¡œë•ì…˜ ë°°í¬

---

## ì°¸ê³  ìžë£Œ

- [Spring Data JPA Query Methods](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods)
- [JPQL JOIN vs Subquery Performance](https://vladmihalcea.com/jpql-subquery-performance/)

---

## ê´€ë ¨ ë¬¸ì„œ

- [ì„±ëŠ¥ ë¹„êµ ê²°ê³¼](./performance-comparison.md) â­ **ì‹¤ì œ ì¸¡ì • ê²°ê³¼**
- [ë¦¬íŒ©í† ë§ ì „ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼](./performance-results-before.md)
- [EXPLAIN ì‹¤í–‰ ê³„íš ë¶„ì„](./explain-results.md)
